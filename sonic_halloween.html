<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sonic AR</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; text-align: center; }
    h1 { font-size: 1.5em; margin: 10px 0; }
    #arContainer { display: none; width: 100%; height: 100vh; position: relative; }
    #openAR { padding: 0.5em 1em; font-size: 0.9em; margin-top: 20px; }
    #camButton { display: none; } /* oculto, se puede activar si quieres */
    #foto { margin-top: 20px; max-width: 90%; display: block; }

    #birthdayFrame {
      position: absolute;
      top: 13vh;
      left: 0;
      width: 100%;
      height: 80%;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 5;
      transform: scale(1.0,1.4);
    }

    #birthdayFrame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div id="birthdayFrame">
    <img src="marco_cumple.png" alt="Feliz Cumpleaños">
  </div>

  <button id="openAR">Abrir Visor AR</button>

  <div id="arContainer">
    <a-scene 
      embedded
      vr-mode-ui="enabled: false"
      style="width: 100%; height: 100vh;" 
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
    
      <!-- Sonic (igual que antes) -->
      <a-entity id="sonic" visible="true"
        gltf-model="url(jet_set_sonic/scene.gltf)"
        scale="0.30 0.30 0.30">
      </a-entity>

      <!-- Tails corregido -->
      <!-- <a-entity id="tails" visible="true"
        gltf-model="url(tails_sonic_free_riders/scene.gltf)"
        position="0 -2 -5"
        rotation="-90 0 0"
        scale="4 4 4">
      </a-entity> -->

      <!-- Cámara -->
      <a-entity camera look-controls position="0 1.6 0" near="0.1" far="1000"></a-entity>
    </a-scene>

    <!-- Botón de foto oculto -->
    <button id="camButton">Tomar Foto</button>
    <img id="foto" />
  </div>

  <script>
    const arContainer = document.getElementById('arContainer');
    const openAR = document.getElementById('openAR');
    const sonic = document.getElementById('sonic');
    const tails = document.getElementById('tails');
    const button = document.getElementById('camButton');
    const foto = document.getElementById('foto');

    // Abrir visor AR
    openAR.addEventListener('click', () => {
      arContainer.style.display = 'block';
    });

    // === Setup para captura de QR ===
    const video = document.createElement('video');
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    let scanning = false;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        console.log("Cámara activada ✅");
        video.srcObject = stream;
        video.setAttribute("playsinline", true);
        video.play();
        scanning = true;
        requestAnimationFrame(tick);
      })
      .catch(err => console.error("Error al activar cámara:", err));

    function tick() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height, { inversionAttempts: "dontInvert" });
        if (code) {
          console.log("QR detectado:", code.data);
          handleQR(code.data);
        }
      }
      requestAnimationFrame(tick);
    }

    function handleQR(data) {
      sonic.setAttribute('visible', 'false');
      tails.setAttribute('visible', 'false');

      if (data.toUpperCase() === 'SONIC') {
        sonic.setAttribute('visible', 'true');
        console.log("Sonic mostrado ✅");
      } else if (data.toUpperCase() === 'TAILS') {
        tails.setAttribute('visible', 'true');
        console.log("Tails mostrado ✅");
      }
    }

    // === Posicionar personajes frente a la cámara automáticamente ===
    const cameraEntity = document.querySelector('[camera]');
    function updateCharacterPosition() {
      if (sonic.getAttribute('visible') === true) {
        sonic.object3D.position.set(cameraEntity.object3D.position.x + 0.5, -0.3, cameraEntity.object3D.position.z - 6);
      }
      if (tails.getAttribute('visible') === true) {
        tails.object3D.position.set(cameraEntity.object3D.position.x, -1.5, cameraEntity.object3D.position.z - 8);
      }
      requestAnimationFrame(updateCharacterPosition);
    }
    updateCharacterPosition();

    // === Botón de foto (oculto, opcional) ===
    button.addEventListener('click', () => {
      const sceneEl = document.querySelector('a-scene');
      if (!sceneEl.canvas) return;

      const combinedCanvas = document.createElement('canvas');
      combinedCanvas.width = sceneEl.canvas.width;
      combinedCanvas.height = sceneEl.canvas.height;
      const ctx = combinedCanvas.getContext('2d');

      ctx.drawImage(video, 0, 0, combinedCanvas.width, combinedCanvas.height);
      ctx.drawImage(sceneEl.canvas, 0, 0, combinedCanvas.width, combinedCanvas.height);

      foto.src = combinedCanvas.toDataURL('image/png');
      foto.style.display = 'block';

      const link = document.createElement('a');
      link.href = combinedCanvas.toDataURL('image/png');
      link.download = 'sonic_ar.png';
      link.click();

      console.log("Foto combinada tomada y descargada ✅");
    });
  </script>
</body>
</html>